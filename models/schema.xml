<?xml version="1.0" encoding="UTF-8"?>
<database name="infop7db" defaultIdMethod="native">

    <!-- === utilisateurs === -->
    <table name="users" phpName="User">

        <!-- == identification == -->
        <column name="id"                    type="INTEGER"  required="true" primaryKey="true" autoIncrement="true"/>
        <!-- login -->
        <column name="username"              type="VARCHAR"  size="16" required="true" />
        <!-- mot de passe (hash bcrypt) -->
        <column name="password_hash"         type="VARCHAR"  required="true" />

        <!-- type d'utilisateur, utilisé pour les droits. Plus le nombre est haut, plus
             l'utilisateur a de droits. Exemples possibles:
                  0 - visiteur (pas inscrit en BDD)
                 50 - membre
                 80 - modérateur
                100 - admin
             On garde de la place pour d'éventuels futurs ajouts.
             -->
        <column name="type"                  type="TINYINT"  required="true" defaultExpr="0" />

        <!-- prénom -->
        <column name="firstname"             type="VARCHAR"  required="true" />
        <!-- nom -->
        <column name="lastname"              type="VARCHAR"  required="true" />

        <!-- genre -->
        <column name="gender"                type="ENUM" valueSet="M,F" required="true" />

        <!-- == coordonnées == -->

        <!-- e-mail -->
        <column name="email"                 type="VARCHAR"  required="true" />
        <!-- tél -->
        <column name="phone"                 type="VARCHAR" size="20" />
        <!-- adresse -->
        <column name="address"               type="VARCHAR" />

        <!-- site web -->
        <column name="website"               type="VARCHAR" />

        <!-- date de naissance -->
        <column name="birth_date"            type="DATE" />

        <!-- == statistiques == -->

        <!-- date de première inscription -->
        <column name="first_entry"           type="DATE" />
        <!-- date de dernière inscription -->
        <column name="last_entry"            type="DATE" />
        <!-- date d'expiration (si un membre) -->
        <column name="expiration_date"       type="DATE" />

        <!-- date de dernière visite -->
        <column name="last_visit"            type="TIMESTAMP" />
        <!-- nb de visites -->
        <column name="visits_nb"             type="INTEGER" defaultExpr="0" />

        <!-- == configuration == -->

        <!-- montrer l'e-mail publiquement -->
        <column name="config_show_email"     type="BOOLEAN" defaultExpr="0" />
        <!-- montrer le tél publiquement -->
        <column name="config_show_phone"     type="BOOLEAN" defaultExpr="0" />
        <!-- montrer le vrai nom publiquement (à la place du pseudo) -->
        <column name="config_show_real_name" type="BOOLEAN" defaultExpr="1" />
		 <!-- montrer la date de naissance publiquement -->
	    <column name="config_show_birthdate" type="BOOLEAN" defaultExpr="0" />
		 <!-- montrer l'age publiquement -->
	    <column name="config_show_age"       type="BOOLEAN" defaultExpr="1" />
		 <!-- montrer l'addresse publiquement -->
	    <column name="config_show_address"   type="BOOLEAN" defaultExpr="0" />
		 <!-- permet l'indexation du profil -->
	    <column name="config_index_profile"  type="BOOLEAN" defaultExpr="0" />

        <!-- désactiver le compte -->
        <column name="deactivated"           type="BOOLEAN" defaultExpr="0" />

        <!-- == autres informations == -->

        <!-- si c'est actuellement un enseignant -->
        <column name="is_a_teacher"          type="BOOLEAN" defaultExpr="0" />
        
        <!-- si c'est actuellement un étudiant -->
        <column name="is_a_student"          type="BOOLEAN" defaultExpr="0" />

        <!-- avatar (= id de fichier) -->
        <column name="avatar_id"             type="INTEGER" />

        <!-- description -->
        <column name="description"           type="LONGVARCHAR" size="512" lazyLoad="true" />

        <!-- commentaires (pour la trésorerie) -->
        <column name="remarks"               type="VARCHAR" lazyLoad="true" />


        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="files" onDelete="SETNULL" onUpdate="CASCADE" phpName="Avatar">
            <reference local="avatar_id" foreign="id" />
        </foreign-key>

        <validator column="username">
            <rule name="minLength" value="4" message="Username must be at least ${value} characters." />
            <rule name="match"     value="/^[a-z](?:[-_]?[a-z0-9]+)+$/i"
                                             message="Please enter a valid username." />
            <rule name="unique"              message="Username already exists." />
        </validator>

        <validator column="firstname">
            <rule name="minLength" value="1" message="First name must be at least ${value} characters." />
        </validator>

        <validator column="lastname">
            <rule name="minLength" value="1" message="Last name must be at least ${value} characters." />
        </validator>

        <validator column="email">
            <rule name="minLength" value="6" message="Email must be at least ${value} characters." />
            <!-- Volontairement laxiste, il est plus facile d'accepter de mauvaises adresses que
                 d'éviter d'en exclure de bonnes. L'adresse est de toute façon validée autrement
                 (e-mail de validation). -->
            <rule name="match"     value="/^[-+\w\.]+@[-\.\w]+\.[a-z]{2,4}$/"
                                             message="Please enter a valid email address." />
        </validator>

        <validator column="website">
            <rule name="match"     value="/^https?/"
                                             message="Please use a valid protocol" />
        </validator>

        <validator column="visits_nb">
            <rule name="minValue"  value="0" message="The number of visits cannot be negative." />
        </validator>

    </table>

    <!-- === cursus: L1,L2,L3,M1,M2 === -->
    <table name="cursus" phpName="Cursus">

        <!-- id -->
        <column name="id"             type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- nom -->
        <column name="short_name"     type="CHAR"    size="2" required="true" />
        <column name="name"           type="VARCHAR" size="16" required="true" />

        <!-- description -->
        <column name="description"    type="LONGVARCHAR" size="1024" lazyLoad="true" />

        <!-- id du responsable -->
        <column name="responsable_id" type="INTEGER" />

        <!-- id de la newsletter associée (s'il y en a une) -->
        <column name="newsletter_id"  type="INTEGER" />

        <!-- == index & clefs étrangères == -->

        <unique>
            <unique-column name="name" />
        </unique>

        <foreign-key foreignTable="users" onDelete="SETNULL" onUpdate="CASCADE" phpName="Responsable" refPhpName="CursusResponsability">
            <reference local="responsable_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="newsletters" onDelete="SETNULL" onUpdate="CASCADE" phpName="Newsletter">
            <reference local="newsletter_id" foreign="id" />
        </foreign-key>

        <validator column="name">
            <rule name="minLength" value="1" message="Name must be at least ${value} characters." />
            <rule name="unique" message="Name already exists." />
        </validator>

        <validator column="short_name">
            <rule name="minLength" value="1" message="Short name must be at least ${value} characters." />
            <rule name="unique" message="Short name already exists." />
        </validator>

        <index>
            <index-column name="short_name" />
        </index>
    </table>

    <!-- cursus au(x)quel(s) sont inscrit les utilisateurs -->
    <table name="users_cursus" isCrossRef="true">
        <!-- id de l'utilisateur -->
        <column name="user_id"   type="INTEGER" primaryKey="true" />
        <!-- id du cursus -->
        <column name="cursus_id" type="INTEGER" primaryKey="true" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="users" onDelete="CASCADE" onUpdate="CASCADE">
            <reference local="user_id" foreign="id"/>
        </foreign-key>
        <foreign-key foreignTable="cursus" onDelete="CASCADE" onUpdate="CASCADE">
            <reference local="cursus_id" foreign="id"/>
        </foreign-key>
    </table>

    <!-- === matières === -->
    <table name="courses" phpName="Course">

        <!-- id -->
        <column name="id"          type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- cursus correspondant -->
        <column name="cursus_id"   type="INTEGER" /> 

        <!-- semestre correspondant -->
        <column name="semester"    type="TINYINT" defaultExpr="0" />

        <!-- si la matière est facultative -->
        <column name="optional"    type="BOOLEAN" required="true" defaultExpr="0" />

        <!-- nom -->
        <column name="name"        type="VARCHAR" size="64" required="true" />

        <!-- code -->
        <column name="code"        type="VARCHAR" size="16" required="true" />

        <!-- nb de crédits -->
        <column name="ECTS"        type="TINYINT" defaultExpr="3" />

        <!-- description -->
        <column name="description" type="LONGVARCHAR" size="1024" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="cursus" onDelete="CASCADE" onUpdate="CASCADE" phpName="Cursus">
            <reference local="cursus_id" foreign="id" />
        </foreign-key>

        <unique>
            <unique-column name="code" />
            <unique-column name="semester" />
            <unique-column name="cursus_id" />
        </unique>

        <validator column="code">
            <rule name="match" value="/^[a-z0-9]+$/i"
                                             message="Please enter a valid code." />
        </validator>

        <validator column="name">
            <rule name="minLength" value="3" message="Name must be at least ${value} characters." />
        </validator>

        <validator column="semester">
            <rule name="minValue"  value="0" message="The semester cannot be negative." />
            <rule name="maxValue"  value="3" message="The semester cannot be higher than 2." />
        </validator>

        <validator column="ECTS">
            <rule name="minValue"  value="0" message="ECTS cannot be negative." />
            <rule name="maxValue"  value="30" message="ECTS cannot be higher than 30." />
        </validator>
    </table>

    <!-- === fichiers === -->
    <table name="files" phpName="File">

        <!-- id -->
        <column name="id"            type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- == Informations basiques == -->

        <!-- auteur (ou celui qui l'a déposé) -->
        <column name="author_id"     type="INTEGER" />

        <!-- nom (= titre, peut être différent du vrai nom du fichier stocké) -->
        <column name="name"          type="VARCHAR" required="true" size="128" />

        <!-- date à laquelle a été posté le fichier -->
        <column name="date"          type="TIMESTAMP" required="true" />

        <!-- courte description -->
        <column name="description"   type="VARCHAR" />

        <!-- type du fichier
                - text : tout ce qui est full text (non binaire)
                - image : images
                - video : vidéos
                - audio : sons
                - pdf   : PDF,PS & assimilés
                - binary : autres fichiers binaires
        -->
        <column name="file_type"     type="ENUM" valueSet="text,image,video,audio,pdf,binary" />

        <!-- == accès == -->

        <!-- chemin d'accès (comprenant le « vrai » nom du fichier) -->
        <column name="path"          type="VARCHAR" required="true" />

        <!-- droits d'accès -->
        <column name="access_rights" type="TINYINT" defaultExpr="0" />

        <!-- == index & clefs étrangères == -->

        <unique>
            <unique-column name="path" />
        </unique>

        <foreign-key foreignTable="users" onDelete="SETNULL" onUpdate="CASCADE" phpName="Author">
            <reference local="author_id" foreign="id" />
        </foreign-key>

        <validator column="name">
            <rule name="minLength" value="3" message="Name must be at least ${value} characters." />
        </validator>

        <validator column="path">
            <rule name="minLength" value="3" message="Path must be at least ${value} characters." />
            <rule name="notMatch"  value="/^[a-z]:\/\//i"
                                             message="Path must be local." />
        </validator>
    </table>

    <!-- === newsletter === -->
    <table name="newsletters" phpName="Newsletter">
        <!-- id -->
        <column name="id"   type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- nom -->
        <column name="name" type="VARCHAR" required="true" />

        <!-- courte description -->
        <column name="description" type="VARCHAR" />

        <unique>
            <unique-column name="name" />
        </unique>
    </table>

    <!-- message de newsletter -->
    <table name="newsletters_posts" phpName="NewsletterPost">

        <!-- id -->
        <column name="id"            type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- id de la newsletter correspondante -->
        <column name="newsletter_id" type="INTEGER" />
        
        <!-- date d'envoi -->
        <column name="date"          type="TIMESTAMP" required="true" />

        <!-- contenu -->
        <column name="text"          type="LONGVARCHAR" required="true" lazyLoad="true" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="newsletters" onDelete="SETNULL" onUpdate="CASCADE" phpName="Newsletter">
            <reference local="newsletter_id" foreign="id" />
        </foreign-key>
    </table>

    <!-- abonnés aux newsletters -->
    <table name="newsletters_subscribers" isCrossRef="true">

        <!-- id de l'abonné -->
        <column name="subscriber_id" type="INTEGER" primaryKey="true"/>
        <!-- id de la newsletter -->
        <column name="newsletter_id" type="INTEGER" primaryKey="true"/>

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="users" onDelete="CASCADE" onUpdate="CASCADE" phpName="Subscriber">
            <reference local="subscriber_id" foreign="id"/>
        </foreign-key>
        <foreign-key foreignTable="newsletters" onDelete="CASCADE" onUpdate="CASCADE" phpName="Newsletter">
            <reference local="newsletter_id" foreign="id"/>
        </foreign-key>
    </table>

    <!-- == alertes == -->
    <table name="alerts" phpName="Alert">
        <!-- id -->
        <column name="id"   type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- utilisateur à notifier (abonné) -->
        <column name="subscriber_id" type="INTEGER" required="true" />

        <!-- cursus concerné (s'il y en a un) -->
        <column name="cursus_id"   type="INTEGER" />

        <!-- matière concernée (s'il y en a une) -->
        <column name="course_id"    type="INTEGER" />

        <!-- tag concerné (s'il y en a un) -->
        <column name="tag_id" type="INTEGER" />

        <!-- type de contenu -->
        <column name="content_type_id" type="INTEGER" />


        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="users" onDelete="CASCADE" onUpdate="CASCADE" phpName="Subscriber">
            <reference local="subscriber_id" foreign="id"/>
        </foreign-key>

        <foreign-key foreignTable="cursus" onDelete="CASCADE" onUpdate="CASCADE" phpName="Cursus">
            <reference local="cursus_id" foreign="id"/>
        </foreign-key>

        <foreign-key foreignTable="courses" onDelete="CASCADE" onUpdate="CASCADE" phpName="Course">
            <reference local="course_id" foreign="id"/>
        </foreign-key>

        <foreign-key foreignTable="tags" onDelete="CASCADE" onUpdate="CASCADE" phpName="Tag">
            <reference local="tag_id" foreign="id"/>
        </foreign-key>

        <foreign-key foreignTable="content_types" onDelete="SETNULL" onUpdate="CASCADE" phpName="ContentType">
            <reference local="content_type_id" foreign="id"/>
        </foreign-key>

    </table>

    <!-- === évènements === -->
    <table name="events" phpName="Event">

        <!-- id -->
        <column name="id"            type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- nom -->
        <column name="name"          type="VARCHAR" required="true" />

        <!-- type: réunion, soirée, conférence, vote, etc -->
        <column name="event_type_id" type="INTEGER" />
        
        <!-- description -->         
        <column name="description"   type="LONGVARCHAR" />
        
        <!-- date -->
        <column name="date"          type="DATE" />
        
        <!-- heure de début -->
        <column name="beginning"     type="TIME" />
        
        <!-- heure de fin -->
        <column name="end"           type="TIME" />
        
        <!-- lieu -->
        <column name="place"         type="VARCHAR" />

        <!-- rang des personnes concernées -->
        <column name="access_rights" type="TINYINT" defaultExpr="0" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="event_types" onDelete="SETNULL" onUpdate="CASCADE" phpName="EventType">
            <reference local="event_type_id" foreign="id"/>
        </foreign-key>

        <validator column="name">
            <rule name="minLength" value="3" message="Name must be at least ${value} characters." />
        </validator>
    </table>

    <!-- === types d'évènements === -->
    <table name="event_types" phpName="EventType">
        <!-- id -->
        <column name="id"   type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>
        <!-- nom -->
        <column name="name" type="VARCHAR" required="true" />

        <!-- == index & clefs étrangères == -->

        <unique>
            <unique-column name="name" />
        </unique>

    </table>

    <!-- === contenus === -->
    <table name="contents" phpName="Content">

        <!-- id -->
        <column name="id"            type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- id de l'auteur -->
        <column name="author_id"     type="INTEGER" />

        <!-- type: examen, projet, etc -->
        <column name="content_type_id" type="INTEGER" />

        <!-- date à laquelle le contenu a été posté -->
        <column name="date"          type="TIMESTAMP" required="true" />

        <!-- droits d'accès -->
        <column name="access_rights" type="TINYINT" defaultExpr="0" />

        <!-- si le contenu a été validé par un responsable -->
        <column name="validated"     type="BOOLEAN" defaultExpr="0" />

        <!-- titre du contenu -->
        <column name="title"         type="VARCHAR" />

        <!-- texte du contenu -->
        <column name="text"          type="LONGVARCHAR" lazyLoad="true" />

        <!-- cursus concerné (s'il y en a un) -->
        <column name="cursus_id"     type="INTEGER" />

        <!-- matière concernée (s'il y en a une) -->
        <column name="course_id"     type="INTEGER" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="users" onDelete="SETNULL" onUpdate="CASCADE" phpName="Author">
            <reference local="author_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="cursus" onDelete="CASCADE" onUpdate="CASCADE" phpName="Cursus">
            <reference local="cursus_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="courses" onDelete="CASCADE" onUpdate="CASCADE" phpName="Course">
            <reference local="course_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="content_types" onDelete="SETNULL" onUpdate="CASCADE" phpName="ContentType">
            <reference local="content_type_id" foreign="id"/>
        </foreign-key>

    </table>

    <!-- fichiers des contenus -->
    <table name="contents_files" isCrossRef="true">
        <!-- id du contenu -->
        <column name="content_id" type="INTEGER" primaryKey="true" />
        <!-- id du fichier -->
        <column name="file_id"    type="INTEGER" primaryKey="true" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="contents" onDelete="CASCADE" onUpdate="CASCADE" phpName="Content">
            <reference local="content_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="files" onDelete="CASCADE" onUpdate="CASCADE" phpName="File">
            <reference local="file_id" foreign="id" />
        </foreign-key>
    </table>

    <!-- === types de contenu : examen, TP, TD, etc === -->
    <table name="content_types" phpName="ContentType">
        <!-- id -->
        <column name="id"   type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- nom -->
        <column name="name" type="VARCHAR" size="32" required="true" />
    </table>

    <!-- === commentaires === -->
    <table name="content_comments" phpName="Comment">

        <!-- id -->
        <column name="id"            type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- id du commentaire auquel celui-ci répond -->
        <column name="reply_to_id"   type="INTEGER" />

        <!-- id du contenu commenté -->
        <column name="content_id"    type="INTEGER" />

        <!-- id de l'auteur -->
        <column name="author_id"     type="INTEGER" />

        <!-- date -->
        <column name="date"          type="TIMESTAMP" required="true" />

        <!-- texte -->
        <column name="text"          type="LONGVARCHAR" size="2048" required="true" lazyLoad="true" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="content_comments" onDelete="SETNULL" onUpdate="CASCADE" phpName="ReplyToComment">
            <reference local="reply_to_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="contents" onDelete="CASCADE" onUpdate="CASCADE" phpName="Content">
            <reference local="content_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="users" onDelete="CASCADE" onUpdate="CASCADE" phpName="Author">
            <reference local="author_id" foreign="id" />
        </foreign-key>

        <validator column="text">
            <rule name="minLength" value="1" message="Text must be at least ${value} characters." />
        </validator>
    </table>

    <!-- === mots-clefs === -->
    <table name="tags" phpName="Tag">
        <!-- id -->
        <column name="id"   type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>
        <!-- nom -->
        <column name="name" type="VARCHAR" size="16" required="true" />

        <!-- == index & clefs étrangères == -->

        <validator column="name">
            <rule name="minLength" value="1" message="Name must be at least ${value} characters." />
            <rule name="unique" message="Name must be unique." />
        </validator>

        <index>
            <index-column name="name" />
        </index>

    </table>

    <!-- associations contenus/mots-clefs -->
    <table name="contents_tags" isCrossRef="true">
        <!-- id du mot-clef -->
        <column name="tag_id"     type="INTEGER" primaryKey="true" />

        <!-- id du contenu -->
        <column name="content_id" type="INTEGER" primaryKey="true" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="tags" onDelete="CASCADE" onUpdate="CASCADE" phpName="Tag">
            <reference local="tag_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="contents" onDelete="CASCADE" onUpdate="CASCADE" phpName="Content">
            <reference local="content_id" foreign="id" />
        </foreign-key>
    </table>

    <!-- associations annonces/mots-clefs -->
    <table name="ads_tags" isCrossRef="true">
        <!-- id du mot-clef -->
        <column name="tag_id" type="INTEGER" primaryKey="true" />

        <!-- id de l'annonce -->
        <column name="ad_id"  type="INTEGER" primaryKey="true" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="tags" onDelete="CASCADE" onUpdate="CASCADE" phpName="Tag">
            <reference local="tag_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="ads" onDelete="CASCADE" onUpdate="CASCADE" phpName="Ad">
            <reference local="ad_id" foreign="id" />
        </foreign-key>
    </table>

    <!-- === contenu signalé === -->
    <table name="reports" phpName="Report">
        <!-- id -->
        <column name="id"         type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- id du contenu -->
        <column name="content_id" type="INTEGER" />
        
        <!-- id du signaleur -->
        <column name="author_id"  type="INTEGER" />

        <!-- date -->
        <column name="date"       type="TIMESTAMP" required="true" />

        <!-- courte explication -->
        <column name="text"       type="VARCHAR" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="contents" onDelete="CASCADE" onUpdate="CASCADE" phpName="Content">
            <reference local="content_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="users" onDelete="SETNULL" onUpdate="CASCADE" phpName="Author">
            <reference local="author_id" foreign="id" />
        </foreign-key>
    </table>


    <!-- === notes === -->
    <table name="notes" phpName="Note">
        <!-- id -->
        <column name="id"         type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- personne qui a eu la note -->
        <column name="user_id"    type="INTEGER" required="true" />

        <!-- matière concernée -->
        <column name="course_id"  type="INTEGER" required="true" />

        <!-- note -->
        <column name="score"      type="FLOAT"   required="true" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="users" onDelete="CASCADE" onUpdate="CASCADE" phpName="User">
            <reference local="user_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="courses" onDelete="CASCADE" onUpdate="CASCADE" phpName="Course">
            <reference local="course_id" foreign="id" />
        </foreign-key>

        <validator column="score">
            <rule name="minValue" value="0" message="Score cannot be negative." />
        </validator>
    </table>

    <!-- === actualités === -->
    <table name="news" phpName="News">
        <!-- id -->
        <column name="id"            type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- auteur -->
        <column name="author_id"     type="INTEGER" required="true" />

        <!-- titre -->
        <column name="title"         type="VARCHAR" required="true" />

        <!-- corps -->
        <column name="text"          type="LONGVARCHAR" size="1024" required="true" />

        <!-- date -->
        <column name="date"          type="TIMESTAMP" required="true" />

        <!-- cursus concerné (s'il y en a un) -->
        <column name="cursus_id"     type="INTEGER" />

        <!-- matière concernée (s'il y en a une) -->
        <column name="course_id"     type="INTEGER" />

        <!-- membres concernés -->
        <column name="access_rights" type="TINYINT" defaultExpr="0" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="users" onDelete="SETNULL" onUpdate="CASCADE" phpName="Author">
            <reference local="author_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="courses" onDelete="CASCADE" onUpdate="CASCADE" phpName="Course">
            <reference local="course_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="cursus" onDelete="CASCADE" onUpdate="CASCADE" phpName="Cursus">
            <reference local="cursus_id" foreign="id" />
        </foreign-key>

        <validator column="title">
            <rule name="minLength" value="1" message="Title must be at least ${value} characters." />
        </validator>

        <validator column="text">
            <rule name="minLength" value="1" message="Text must be at least ${value} characters." />
        </validator>

    </table>

    <!-- === (petites) annonces (dont offres de stages) === -->
    <table name="ads" phpName="Ad">
        <!-- id -->
        <column name="id"        type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- auteur -->
        <column name="author_id" type="INTEGER" required="true" />

        <!-- titre -->
        <column name="title"     type="VARCHAR" required="true" />

        <!-- corps -->
        <column name="text"      type="LONGVARCHAR" size="400" />

        <!-- date -->
        <column name="date"      type="TIMESTAMP" required="true" />

        <!-- si l'annonce a été validée (ex: par un responsable) -->
        <column name="validated" type="BOOLEAN" defaultExpr="1" />

        <!-- droits d'accès -->
        <column name="access_rights" type="TINYINT" defaultExpr="0" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="users" onDelete="CASCADE" onUpdate="CASCADE" phpName="Author">
            <reference local="author_id" foreign="id" />
        </foreign-key>

        <validator column="title">
            <rule name="minLength" value="1" message="Title must be at least ${value} characters." />
        </validator>

    </table>

    <!-- === Transactions (trésorerie) === -->
    <table name="transactions" phpName="Transaction">
        <!-- id -->
        <column name="id"          type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- description -->
        <column name="description" type="VARCHAR" required="true" />

        <!-- montant -->
        <column name="amount"      type="DOUBLE" required="true" defaultExpr="0" />

        <!-- personne concernée (s'il y en a une) -->
        <column name="user_id"     type="INTEGER" />

        <!-- transaction validée ou non -->
        <column name="validated"   type="BOOLEAN" defaultExpr="0" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="users" onDelete="SETNULL" onUpdate="CASCADE" phpName="User">
            <reference local="user_id" foreign="id" />
        </foreign-key>

        <validator column="description">
            <rule name="minLength" value="1" message="Description must be at least ${value} characters." />
        </validator>
    </table>

    <!-- === (sous-)catégories du forum === -->
    <table name="forum_categories" phpName="ForumCategory">
        <!-- id -->
        <column name="id"            type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- nom -->
        <column name="name"          type="VARCHAR" size="32" required="true" />

        <!-- id de la catégorie parente (s'il y en a une) -->
        <column name="parent_id"     type="INTEGER" />

        <!-- rang des utilisateurs qui peuvent y accéder -->
        <column name="access_rights" type="TINYINT" defaultExpr="0" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="forum_categories" onDelete="SETNULL" onUpdate="CASCADE" phpName="ParentCategory">
            <reference local="parent_id" foreign="id" />
        </foreign-key>

        <validator column="name">
            <rule name="minLength" value="1" message="Name must be at least ${value} characters." />
        </validator>
    </table>

    <!-- === sujets des forums === -->
    <table name="forum_topics" phpName="ForumTopic">
        <!-- id -->
        <column name="id"              type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- id de la catégorie parente -->
        <column name="category_id"     type="INTEGER" required="true" />

        <!-- titre -->
        <column name="title"           type="VARCHAR" required="true" />

        <!-- si le sujet est verrouillé -->
        <column name="is_locked"       type="BOOLEAN" defaultExpr="0" />

        <!-- si le sujet est une annonce -->
        <column name="is_announcement" type="BOOLEAN" defaultExpr="0" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="forum_categories" onDelete="CASCADE" onUpdate="CASCADE" phpName="Category">
            <reference local="category_id" foreign="id" />
        </foreign-key>

        <validator column="title">
            <rule name="minLength" value="1" message="Title must be at least ${value} characters." />
        </validator>
    </table>

    <!-- === messages des forums === -->
    <table name="forum_messages" phpName="ForumMessage">
        <!-- id -->
        <column name="id"                type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- id de l'auteur -->
        <column name="author_id"         type="INTEGER" required="true" />

        <!-- id du sujet -->
        <column name="topic_id"          type="INTEGER" required="true" />

        <!-- date de dernière modification -->
        <column name="last_modification" type="TIMESTAMP" required="true" />

        <!-- texte -->
        <column name="text"              type="LONGVARCHAR" required="true" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="users" onDelete="CASCADE" onUpdate="CASCADE" phpName="Author">
            <reference local="author_id" foreign="id" />
        </foreign-key>

        <foreign-key foreignTable="forum_topics" onDelete="CASCADE" onUpdate="CASCADE" phpName="Topic">
            <reference local="topic_id" foreign="id" />
        </foreign-key>

        <validator column="text">
            <rule name="minLength" value="1" message="Texte must be at least ${value} characters." />
        </validator>
    </table>

    <!-- === Examens/partiels === -->
    <table name="exams" phpName="Exam">
        <!-- id -->
        <column name="id"        type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- id de la matière -->
        <column name="course_id" type="INTEGER" required="true" />
        
        <!-- jour -->
        <column name="date"      type="DATE" required="true" />
        
        <!-- heure de début -->
        <column name="beginning" type="TIME" />

        <!-- heure de fin -->
        <column name="end"       type="TIME" />

        <!-- remarques -->
        <column name="comments" type="VARCHAR" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="courses" onDelete="CASCADE" onUpdate="CASCADE" phpName="Course">
            <reference local="course_id" foreign="id"/>
        </foreign-key>

    </table>

    <!-- === Emplois du temps === --> 
    <table name="schedules" phpName="Schedule">
        <!-- id -->
        <column name="id"        type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>

        <!-- id du cursus concerné -->
        <column name="cursus_id" type="INTEGER" />
        
        <!-- nom -->
        <column name="name"      type="VARCHAR" size="32" required="true" />
        
        <!-- date de début de validité -->
        <column name="beginning" type="DATE" />
        
        <!-- date d'expiration -->
        <column name="end" type="DATE" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="cursus" onDelete="CASCADE" onUpdate="CASCADE" phpName="Cursus">
            <reference local="cursus_id" foreign="id"/>
        </foreign-key>
    
    </table>

    <!-- === matières des EDT === -->
    <table name="scheduled_courses" phpName="ScheduledCourse">
        <!-- id -->
        <column name="id"           type="INTEGER" required="true" primaryKey="true" autoIncrement="true"/>
        
        <!-- id de la matière concernée -->
        <column name="course_id"    type="INTEGER" required="true" />
        
        <!-- id de l'enseignant (s'il est inscrit) -->
        <column name="teacher_id"   type="INTEGER" />
        
        <!-- nom de l'enseignant (utiliser l'id s'il est inscrit) -->
        <column name="teacher_name" type="VARCHAR" size="32" />
        
        <!-- jour de la semaine -->
        <column name="weekday"      type="ENUM" valueSet="monday|tuesday|wednesday|thursday|friday|saturday" />
        
        <!-- heure de début -->
        <column name="beginning"    type="TIME" />
        
        <!-- heure de fin -->
        <column name="end"          type="TIME" />
        
        <!-- nom de la salle/amphi -->
        <column name="place"        type="VARCHAR" size="32" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="courses" onDelete="CASCADE" onUpdate="CASCADE" phpName="Course">
            <reference local="course_id" foreign="id"/>
        </foreign-key>

        <foreign-key foreignTable="users" onDelete="SETNULL" onUpdate="CASCADE" phpName="Teacher">
            <reference local="teacher_id" foreign="id"/>
        </foreign-key>
    </table>

    <!-- lien matières+horaires / EDT -->
    <table name="schedules_courses" isCrossRef="true">
        <!-- id de l'EDT -->
        <column name="schedule_id"         type="INTEGER" primaryKey="true" />
        <!-- id de la matière -->
        <column name="scheduled_course_id" type="INTEGER" primaryKey="true" />

        <!-- == index & clefs étrangères == -->

        <foreign-key foreignTable="schedules" onDelete="CASCADE" onUpdate="CASCADE">
            <reference local="schedule_id" foreign="id"/>
        </foreign-key>
        <foreign-key foreignTable="scheduled_courses" onDelete="CASCADE" onUpdate="CASCADE">
            <reference local="scheduled_course_id" foreign="id"/>
        </foreign-key>
    </table>

</database>
